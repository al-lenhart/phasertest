<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fairy Kingdom Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #111;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        canvas {
            border: 2px solid #4a5568;
            box-shadow: 0 0 20px rgba(255, 192, 203, 0.6);
        }
        #game-container {
            position: relative;
        }
        #instructions {
            color: white;
            text-align: center;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }
        #ui-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #8a2be2;
            display: none;
            max-height: 500px;
            overflow-y: auto;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.6);
        }
        .upgrade-btn {
            background: linear-gradient(to bottom, #8a2be2, #4a0080);
            border: none;
            color: white;
            padding: 8px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .upgrade-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            background: linear-gradient(to bottom, #9b4dff, #6a20a0);
        }
        .upgrade-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .upgrade-btn:disabled {
            background: linear-gradient(to bottom, #666666, #333333);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #daily-challenge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ff9900;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.6);
        }
        .reward-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.1);
            background: linear-gradient(to bottom, #8a2be2, #4a0080);
            border: 3px solid gold;
            border-radius: 15px;
            padding: 20px;
            color: white;
            text-align: center;
            font-size: 24px;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .spin {
            animation: spin 0.5s ease-out;
        }
        .pulse {
            animation: pulse 0.5s ease-out;
        }
        .shake {
            animation: shake 0.5s ease-out;
        }
        @keyframes spin {
            0% { transform: rotate(0); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        #streak-meter {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 10px;
            border-radius: 8px;
            color: white;
            border: 2px solid #32cd32;
            box-shadow: 0 0 15px rgba(50, 205, 50, 0.6);
        }
        .streak-bar {
            width: 150px;
            height: 15px;
            background-color: #444;
            border-radius: 7px;
            margin-top: 5px;
            overflow: hidden;
        }
        .streak-progress {
            height: 100%;
            background: linear-gradient(to right, #32cd32, #9acd32);
            width: 0%;
            transition: width 0.3s;
        }
        #combo-text {
            position: absolute;
            font-size: 24px;
            color: #ff0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            pointer-events: none;
            z-index: 1000;
        }
        .notification {
            position: absolute;
            top: 120px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ff9900;
            margin-bottom: 10px;
            transform: translateX(200%);
            transition: transform 0.5s;
            z-index: 100;
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.6);
        }
        #splash-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #4a0080, #200040);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #splash-title {
            font-size: 48px;
            color: #fff;
            text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff69b4;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }
        #press-enter {
            font-size: 24px;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #8a2be2;
            animation: blink 1.5s infinite;
            cursor: pointer;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .bonus-text {
            position: absolute;
            color: gold;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            pointer-events: none;
            z-index: 1000;
            animation: float-up 1.5s forwards;
        }
        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-100px); opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="game"></div>
        <div id="instructions">
            <p>Arrow keys: Move left/right | Spacebar: Jump | F: Shoot fireball | E: Open shop | M: Toggle music</p>
        </div>
        <div id="ui-overlay">
            <h3>Fairy Kingdom Shop</h3>
            <div id="coins-display">Fairy Coins: 0</div>
            <div id="gems-display">Magic Gems: 0</div>
            <div id="upgrade-list">
                <div>
                    <button class="upgrade-btn" id="upgrade-speed">Speed Boost (50 coins)</button>
                    <span id="speed-level">Lvl 0</span>
                </div>
                <div>
                    <button class="upgrade-btn" id="upgrade-jump">Jump Power (75 coins)</button>
                    <span id="jump-level">Lvl 0</span>
                </div>
                <div>
                    <button class="upgrade-btn" id="upgrade-fireball">Fireball Power (100 coins)</button>
                    <span id="fireball-level">Lvl 0</span>
                </div>
                <div>
                    <button class="upgrade-btn" id="upgrade-cooldown">Cooldown Reduction (125 coins)</button>
                    <span id="cooldown-level">Lvl 0</span>
                </div>
                <div>
                    <button class="upgrade-btn" id="buy-life">Extra Life (200 coins)</button>
                    <span id="lives-count">Lives: 3</span>
                </div>
                <div>
                    <button class="upgrade-btn" id="unlock-area">Unlock New Area (500 coins)</button>
                    <span id="area-level">Area 1</span>
                </div>
                <div>
                    <button class="upgrade-btn" id="buy-doubler">Coin Doubler (2 gems)</button>
                    <span id="doubler-status">Inactive</span>
                </div>
                <div>
                    <button class="upgrade-btn" id="buy-wings">Fairy Wings (3 gems)</button>
                    <span id="wings-status">Inactive</span>
                </div>
            </div>
            <hr>
            <div id="daily-rewards">
                <h4>Daily Rewards</h4>
                <div id="daily-streak">Login Streak: Day 1</div>
                <button class="upgrade-btn" id="claim-daily">Claim Daily Bonus</button>
            </div>
            <hr>
            <div id="special-offers">
                <h4>⭐ Limited Time Offers ⭐</h4>
                <div id="offer-container"></div>
            </div>
            <button class="upgrade-btn" id="close-shop">Close Shop</button>
        </div>
        <div id="daily-challenge"></div>
        <div id="streak-meter">
            <div>Combo Streak: <span id="streak-count">0x</span></div>
            <div class="streak-bar">
                <div class="streak-progress"></div>
            </div>
        </div>
        <div id="combo-text"></div>
        <div id="splash-screen">
            <div id="splash-title">Fairy Kingdom Builder</div>
            <div id="press-enter">Press ENTER to Start</div>
        </div>
    </div>

    <script>
        // Storage management for persistent progress
        const SAVE_KEY = 'fairy_kingdom_save';
        const DAILY_KEY = 'fairy_kingdom_daily';
        
        // Initial player stats (can be upgraded)
        let playerStats = {
            speed: 160,
            jumpPower: 400,
            fireballPower: 1,
            fireballCooldown: 500,
            coins: 0,
            gems: 0,
            lives: 3,
            maxLives: 5,
            unlockedAreas: 1,
            speedLevel: 0,
            jumpLevel: 0,
            fireballLevel: 0,
            cooldownLevel: 0,
            coinMultiplier: 1,
            hasWings: false,
            dailyStreak: 0,
            lastLogin: null,
            claimedToday: false,
            completedLevels: {},
            achievements: {},
            totalPlayTime: 0,
            itemsCollected: 0,
            enemiesDefeated: 0,
            highestCombo: 0
        };
        
        // Combo/streak system
        let comboSystem = {
            current: 0,
            maxCombo: 10,
            multiplier: 1,
            timer: null,
            timerDuration: 5000, // 5 seconds to maintain combo
            comboDecay: 500,     // lose combo after 5 seconds
            add: function(scene) {
                this.current++;
                if (this.current > playerStats.highestCombo) {
                    playerStats.highestCombo = this.current;
                }
                
                this.multiplier = 1 + (Math.min(this.current, this.maxCombo) * 0.1);
                
                // Update UI
                document.getElementById('streak-count').textContent = `${this.current}x`;
                document.querySelector('.streak-progress').style.width = 
                    `${Math.min(this.current / this.maxCombo, 1) * 100}%`;
                
                // Reset timer
                if (this.timer) clearTimeout(this.timer);
                
                // Start combo decay
                this.timer = setTimeout(() => {
                    this.reset();
                }, this.timerDuration - (this.current * this.comboDecay));
                
                // Show combo text effect
                if (scene && this.current > 1) {
                    showComboText(scene, this.current, this.multiplier);
                }
                
                // Reward for hitting combo milestones
                if (this.current === 5) {
                    addNotification("5x Combo! Speed boost activated!");
                    scene.player.setTint(0x00ffff);
                    scene.time.delayedCall(3000, () => {
                        scene.player.clearTint();
                    });
                }
                
                if (this.current === 10) {
                    addNotification("10x COMBO! SUPER POWERS ACTIVATED!");
                    playerStats.fireballPower *= 2;
                    scene.fireballPowerBoost = true;
                    scene.player.setTint(0xff0000);
                    
                    scene.time.delayedCall(5000, () => {
                        playerStats.fireballPower /= 2;
                        scene.fireballPowerBoost = false;
                        scene.player.clearTint();
                    });
                }
            },
            reset: function() {
                this.current = 0;
                this.multiplier = 1;
                document.getElementById('streak-count').textContent = `${this.current}x`;
                document.querySelector('.streak-progress').style.width = '0%';
                clearTimeout(this.timer);
                this.timer = null;
            }
        };
        
        // Daily challenges
        const challenges = [
            { text: "Collect 15 rings", target: 15, type: "rings", reward: 100 },
            { text: "Defeat 10 enemies", target: 10, type: "enemies", reward: 150 },
            { text: "Reach the finish with at least 200 coins", target: 200, type: "coins", reward: 200 },
            { text: "Complete the level without using fireballs", target: 0, type: "nofireball", reward: 250 },
            { text: "Complete the level in under 60 seconds", target: 60, type: "time", reward: 300 },
            { text: "Achieve a 10x combo streak", target: 10, type: "combo", reward: 200 },
            { text: "Collect 5 gems", target: 5, type: "gems", reward: 3, rewardType: "gems" },
            { text: "Jump 30 times", target: 30, type: "jumps", reward: 100 }
        ];
        
        // Limited-time offers
        const specialOffers = [
            { 
                name: "Starter Pack", 
                description: "500 coins + 5 gems", 
                cost: { type: "gems", amount: 2 },
                reward: { coins: 500, gems: 5 },
                duration: 86400000 // 24 hours
            },
            { 
                name: "Super Power Bundle", 
                description: "Speed +2, Jump +2, Fireball +2", 
                cost: { type: "gems", amount: 5 },
                reward: { speedUp: 2, jumpUp: 2, fireballUp: 2 },
                duration: 86400000 // 24 hours
            },
            { 
                name: "Treasure Hunter", 
                description: "3x Coins for 10 minutes", 
                cost: { type: "coins", amount: 300 },
                reward: { coinMultiplier: 3, duration: 600000 }, // 10 minutes
                duration: 43200000 // 12 hours
            }
        ];
        
        // Active effects/buffs
        let activeEffects = {
            coinMultiplier: { active: false, value: 1, timer: null },
            speedBoost: { active: false, value: 1, timer: null },
            powerBoost: { active: false, value: 1, timer: null }
        };
        
        // Game configuration
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 400 },
                    debug: false
                }
            },
            scene: [
                BootScene,
                SplashScene,
                MenuScene,
                GameScene,
                UIScene,
                LevelSelectScene,
                AchievementScene,
                DailyBonusScene
            ]
        };
        
        // Create game instance
        const game = new Phaser.Game(config);
        
        // Boot Scene - loads assets
        function BootScene() {
            Phaser.Scene.call(this, { key: 'BootScene' });
        }
        
        BootScene.prototype = Object.create(Phaser.Scene.prototype);
        BootScene.prototype.constructor = BootScene;
        
        BootScene.prototype.preload = function() {
            // Show loading progress
            let progressBar = this.add.graphics();
            let progressBox = this.add.graphics();
            progressBox.fillStyle(0x222222, 0.8);
            progressBox.fillRect(240, 270, 320, 50);
            
            let width = this.cameras.main.width;
            let height = this.cameras.main.height;
            let loadingText = this.make.text({
                x: width / 2,
                y: height / 2 - 50,
                text: 'Loading...',
                style: {
                    font: '20px monospace',
                    fill: '#ffffff'
                }
            });
            loadingText.setOrigin(0.5, 0.5);
            
            // Loading event listeners
            this.load.on('progress', function (value) {
                progressBar.clear();
                progressBar.fillStyle(0xffffff, 1);
                progressBar.fillRect(250, 280, 300 * value, 30);
            });
            
            this.load.on('complete', function () {
                progressBar.destroy();
                progressBox.destroy();
                loadingText.destroy();
            });
            
            // Load assets
            this.load.image('sky', 'https://labs.phaser.io/assets/skies/space3.png');
            this.load.image('mountains', 'https://labs.phaser.io/assets/skies/sky1.png');
            this.load.image('forest', 'https://labs.phaser.io/assets/skies/sky4.png');
            this.load.image('ground', 'https://labs.phaser.io/assets/sprites/platform.png');
            this.load.image('ring', 'https://labs.phaser.io/assets/sprites/orb-blue.png');
            this.load.image('coin', 'https://labs.phaser.io/assets/sprites/coin.png');
            this.load.image('gem', 'https://labs.phaser.io/assets/sprites/diamond.png');
            this.load.image('chest', 'https://labs.phaser.io/assets/sprites/treasure_trap.png');
            this.load.image('fireball', 'https://labs.phaser.io/assets/sprites/bullets/bullet7.png');
            this.load.image('enemy', 'https://labs.phaser.io/assets/sprites/wasp.png');
            this.load.image('boss', 'https://labs.phaser.io/assets/sprites/spinObj_01.png');
            this.load.image('finish', 'https://labs.phaser.io/assets/sprites/block.png');
            this.load.image('heart', 'https://labs.phaser.io/assets/sprites/heart.png');
            this.load.image('sparkle', 'https://labs.phaser.io/assets/particles/blue.png');
            this.load.image('redsparkle', 'https://labs.phaser.io/assets/particles/red.png');
            this.load.image('greensparkle', 'https://labs.phaser.io/assets/particles/green.png');
            this.load.image('portal', 'https://labs.phaser.io/assets/sprites/orb-red.png');
            this.load.image('powerup', 'https://labs.phaser.io/assets/sprites/mushroom.png');
            this.load.image('button', 'https://labs.phaser.io/assets/sprites/button-green.png');
            this.load.image('signpost', 'https://labs.phaser.io/assets/sprites/signpost.png');
            this.load.image('cloud', 'https://labs.phaser.io/assets/sprites/cloud.png');
            this.load.image('star', 'https://labs.phaser.io/assets/sprites/star.png');
            
            this.load.spritesheet('fairy', 'https://labs.phaser.io/assets/sprites/bmo.png', { frameWidth: 32, frameHeight: 48 });
            this.load.spritesheet('explosion', 'https://labs.phaser.io/assets/sprites/explosion.png', { frameWidth: 64, frameHeight: 64, endFrame: 23 });
            this.load.spritesheet('coins', 'https://labs.phaser.io/assets/sprites/coins.png', { frameWidth: 16, frameHeight: 16 });
            this.load.spritesheet('gems', 'https://labs.phaser.io/assets/sprites/diamonds.png', { frameWidth: 16, frameHeight: 16 });
            
            // Load audio
            this.load.audio('jump', 'https://labs.phaser.io/assets/audio/SoundEffects/jump.wav');
            this.load.audio('collect', 'https://labs.phaser.io/assets/audio/SoundEffects/coin.wav');
            this.load.audio('explosion', 'https://labs.phaser.io/assets/audio/SoundEffects/explosion.wav');
            this.load.audio('fire', 'https://labs.phaser.io/assets/audio/SoundEffects/laser.wav');
            this.load.audio('music', 'https://labs.phaser.io/assets/audio/music/fairy-waltz.mp3');
            this.load.audio('victory', 'https://labs.phaser.io/assets/audio/music/fairy-glade.mp3');
            this.load.audio('gameover', 'https://labs.phaser.io/assets/audio/SoundEffects/negative.wav');
            this.load.audio('powerup', 'https://labs.phaser.io/assets/audio/SoundEffects/powerup.wav');
            this.load.audio('reward', 'https://labs.phaser.io/assets/audio/SoundEffects/key.wav');
            this.load.audio('combo', 'https://labs.phaser.io/assets/audio/SoundEffects/numkey.wav');
            this.load.audio('click', 'https://labs.phaser.io/assets/audio/SoundEffects/shot.wav');
            this.load.audio('bonus', 'https://labs.phaser.io/assets/audio/SoundEffects/magical_horror_audiosprite.wav');
        };
        
        BootScene.prototype.create = function() {
            // Load saved data if exists
            loadSavedGame();
            
            // Check for daily login
            checkDailyLogin();
            
            // Set daily challenge
            setDailyChallenge();
            
            // Initialize offers
            initializeOffers();
            
            // Go to splash screen
            this.scene.start('SplashScene');
        };

        // Splash Screen Scene
        function SplashScene() {
            Phaser.Scene.call(this, { key: 'SplashScene' });
        }
        
        SplashScene.prototype = Object.create(Phaser.Scene.prototype);
        SplashScene.prototype.constructor = SplashScene;
        
        SplashScene.prototype.create = function() {
            // Hide the HTML splash screen since we're using Phaser for the real splash
            document.getElementById('splash-screen').style.display = 'flex';
            
            // Wait for Enter key press
            const enterKey = this.input.keyboard.addKey('ENTER');
            enterKey.on('down', () => {
                document.getElementById('splash-screen').style.display = 'none';
                this.scene.start('MenuScene');
                
                // Play click sound
                this.sound.play('click');
            });
            
            // Also allow mouse click to start
            document.getElementById('press-enter').addEventListener('click', () => {
                document.getElementById('splash-screen').style.display = 'none';
                this.scene.start('MenuScene');
                
                // Play click sound if possible
                if (this.sound) {
                    this.sound.play('click');
                }
            });
            
            // Create fairy dust particles behind the splash text
            const particles = this.add.particles('sparkle');
            
            particles.createEmitter({
                x: 400,
                y: 300,
                speed: { min: 50, max: 150 },
                angle: { min: 0, max: 360 },
                scale: { start: 0.4, end: 0 },
                blendMode: 'ADD',
                lifespan: 3000,
                gravityY: 30,
                frequency: 100
            });
            
            // Add sparkles to the Enter button
            const btnParticles = this.add.particles('star');
            
            btnParticles.createEmitter({
                x: 400,
                y: 350,
                speed: { min: 20, max: 70 },
                angle: { min: 270, max: 360 },
                scale: { start: 0.2, end: 0 },
                blendMode: 'ADD',
                lifespan: 1000,
                frequency: 300
            });
        };
        
        // Menu Scene
        function MenuScene() {
            Phaser.Scene.call(this, { key: 'MenuScene' });
        }
        
        MenuScene.prototype = Object.create(Phaser.Scene.prototype);
        MenuScene.prototype.constructor = MenuScene;
        
        MenuScene.prototype.create = function() {
            // Background
            const sky = this.add.tileSprite(400, 300, 800, 600, 'sky');
            
            // Animation for background
            this.tweens.add({
                targets: sky,
                tilePositionX: 100,
                duration: 10000,
                repeat: -1,
                yoyo: true
            });
            
            // Fairy Kingdom title with glow effect
            const titleStyle = {
                fontSize: '52px',
                fill: '#ffffff',
                fontStyle: 'bold',
                stroke: '#8a2be2',
                strokeThickness: 8,
                shadow: {
                    offsetX: 2,
                    offsetY: 2,
                    color: '#000',
                    blur: 5,
                    fill: true
                }
            };
            
            const title = this.add.text(400, 100, 'Fairy Kingdom Builder', titleStyle).setOrigin(0.5);
            
            // Subtitle
            this.add.text(400, 160, 'Begin your magical adventure!', {
                fontSize: '24px',
                fill: '#ffff99',
                stroke: '#000000',
                strokeThickness: 4
            }).setOrigin(0.5);
            
            // Menu buttons with better visual design
            this.createButton(400, 250, 'Play Game', () => {
                this.sound.play('click');
                this.cameras.main.fadeOut(500, 0, 0, 0);
                this.cameras.main.once('camerafadeoutcomplete', () => {
                    this.scene.start('LevelSelectScene');
                });
            });
            
            this.createButton(400, 320, 'Daily Bonus', () => {
                this.sound.play('click');
                this.cameras.main.fadeOut(500, 0, 0, 0);
                this.cameras.main.once('camerafadeoutcomplete', () => {
                    this.scene.start('DailyBonusScene');
                });
            });
            
            this.createButton(400, 390, 'Achievements', () => {
                this.sound.play('click');
                this.cameras.main.fadeOut(500, 0, 0, 0);
                this.cameras.main
              this.cameras.main.once('camerafadeoutcomplete', () => {
                    this.scene.start('AchievementScene');
                });
            });
            
            this.createButton(400, 460, 'Reset Game', () => {
                if (confirm('Are you sure you want to reset all progress?')) {
                    this.sound.play('click');
                    resetGame();
                    this.scene.restart();
                }
            });
            
            // Music button
            const musicBtn = this.add.image(750, 30, 'button').setScale(0.5);
            const musicText = this.add.text(750, 30, 'Music', {
                fontSize: '16px',
                fill: '#000'
            }).setOrigin(0.5);
            
            musicBtn.setInteractive();
            musicBtn.on('pointerdown', () => {
                this.sound.play('click');
                
                if (this.sound.get('music')) {
                    if (this.sound.get('music').isPlaying) {
                        this.sound.get('music').pause();
                        musicText.setText('Music: Off');
                    } else {
                        this.sound.get('music').resume();
                        musicText.setText('Music: On');
                    }
                } else {
                    this.sound.play('music', { loop: true, volume: 0.5 });
                    musicText.setText('Music: On');
                }
            });
            
            // Player stats display
            this.add.text(30, 550, `Coins: ${playerStats.coins} | Gems: ${playerStats.gems}`, {
                fontSize: '18px',
                fill: '#ffff00',
                stroke: '#000000',
                strokeThickness: 3
            });
            
            // Add fairy dust particles
            const particles = this.add.particles('sparkle');
            
            particles.createEmitter({
                x: 400,
                y: 100,
                speed: { min: 50, max: 150 },
                angle: { min: 0, max: 360 },
                scale: { start: 0.2, end: 0 },
                blendMode: 'ADD',
                lifespan: 2000,
                frequency: 200
            });
            
            // Background music
            if (!this.sound.get('music')) {
                this.sound.play('music', { loop: true, volume: 0.5 });
                musicText.setText('Music: On');
            }
            
            // Fadein effect
            this.cameras.main.fadeIn(1000, 0, 0, 0);
        };
        
        MenuScene.prototype.createButton = function(x, y, text, callback) {
            const button = this.add.image(x, y, 'button').setScale(1.5, 1);
            button.setInteractive({ useHandCursor: true });
            
            const buttonText = this.add.text(x, y, text, {
                fontSize: '24px',
                fill: '#000'
            }).setOrigin(0.5);
            
            // Button animation on hover
            button.on('pointerover', () => {
                this.tweens.add({
                    targets: button,
                    scaleX: 1.6,
                    duration: 100
                });
            });
            
            button.on('pointerout', () => {
                this.tweens.add({
                    targets: button,
                    scaleX: 1.5,
                    duration: 100
                });
            });
            
            // Button click animation and callback
            button.on('pointerdown', () => {
                this.tweens.add({
                    targets: button,
                    scaleY: 0.9,
                    duration: 100,
                    yoyo: true,
                    onComplete: callback
                });
            });
            
            return { button, text: buttonText };
        };
        
        // Level Selection Scene
        function LevelSelectScene() {
            Phaser.Scene.call(this, { key: 'LevelSelectScene' });
        }
        
        LevelSelectScene.prototype = Object.create(Phaser.Scene.prototype);
        LevelSelectScene.prototype.constructor = LevelSelectScene;
        
        LevelSelectScene.prototype.create = function() {
            // Background
            this.add.image(400, 300, 'forest');
            
            // Title
            this.add.text(400, 50, 'Select Level', {
                fontSize: '40px',
                fill: '#ffffff',
                stroke: '#000000',
                strokeThickness: 5
            }).setOrigin(0.5);
            
            // Create level buttons
            const levelsPerRow = 4;
            const buttonWidth = 150;
            const buttonHeight = 100;
            const startX = 175;
            const startY = 150;
            
            for (let i = 0; i < playerStats.unlockedAreas; i++) {
                const row = Math.floor(i / levelsPerRow);
                const col = i % levelsPerRow;
                
                const x = startX + col * buttonWidth;
                const y = startY + row * buttonHeight;
                
                this.createLevelButton(x, y, i + 1);
            }
            
            // Back button
            const backBtn = this.add.image(100, 50, 'button').setScale(0.7);
            backBtn.setInteractive({ useHandCursor: true });
            
            this.add.text(100, 50, 'Back', {
                fontSize: '18px',
                fill: '#000'
            }).setOrigin(0.5);
            
            backBtn.on('pointerdown', () => {
                this.sound.play('click');
                this.scene.start('MenuScene');
            });
        };
        
        LevelSelectScene.prototype.createLevelButton = function(x, y, levelNum) {
            const isCompleted = playerStats.completedLevels && playerStats.completedLevels[`level${levelNum}`];
            
            const button = this.add.image(x, y, 'button').setScale(1.2);
            button.setInteractive({ useHandCursor: true });
            
            // Level number text
            this.add.text(x, y - 15, `Level ${levelNum}`, {
                fontSize: '22px',
                fill: '#000'
            }).setOrigin(0.5);
            
            // Show completion stars if level is completed
            if (isCompleted) {
                const stars = this.add.image(x, y + 15, 'star').setScale(0.5);
                
                // Add completion stars animation
                this.tweens.add({
                    targets: stars,
                    angle: 360,
                    duration: 6000,
                    repeat: -1
                });
            }
            
            // Button click handler
            button.on('pointerdown', () => {
                this.sound.play('click');
                this.scene.start('GameScene', { level: levelNum });
            });
            
            // Button hover effect
            button.on('pointerover', () => {
                this.tweens.add({
                    targets: button,
                    scaleX: 1.3,
                    duration: 100
                });
            });
            
            button.on('pointerout', () => {
                this.tweens.add({
                    targets: button,
                    scaleX: 1.2,
                    duration: 100
                });
            });
            
            return button;
        };
        
        // Achievements Scene
        function AchievementScene() {
            Phaser.Scene.call(this, { key: 'AchievementScene' });
        }
        
        AchievementScene.prototype = Object.create(Phaser.Scene.prototype);
        AchievementScene.prototype.constructor = AchievementScene;
        
        AchievementScene.prototype.create = function() {
            // Background
            this.add.image(400, 300, 'sky');
            
            // Title
            this.add.text(400, 50, 'Achievements', {
                fontSize: '40px',
                fill: '#ffffff',
                stroke: '#000000',
                strokeThickness: 5
            }).setOrigin(0.5);
            
            // Define achievements
            const achievements = [
                { id: 'collector', name: 'Collector', description: 'Collect 100 coins', requirement: playerStats.itemsCollected >= 100 },
                { id: 'explorer', name: 'Explorer', description: 'Unlock 3 areas', requirement: playerStats.unlockedAreas >= 3 },
                { id: 'comboPro', name: 'Combo Master', description: 'Reach a 10x combo', requirement: playerStats.highestCombo >= 10 },
                { id: 'slayer', name: 'Enemy Slayer', description: 'Defeat 50 enemies', requirement: playerStats.enemiesDefeated >= 50 },
                { id: 'wealthy', name: 'Wealthy Fairy', description: 'Have 1000 coins at once', requirement: playerStats.coins >= 1000 },
                { id: 'winged', name: 'Winged Wonder', description: 'Purchase fairy wings', requirement: playerStats.hasWings },
                { id: 'speedster', name: 'Speedster', description: 'Max out speed upgrade', requirement: playerStats.speedLevel >= 5 },
                { id: 'daily', name: 'Dedicated Player', description: 'Login for 7 days in a row', requirement: playerStats.dailyStreak >= 7 }
            ];
            
            // Display achievements
            const startY = 130;
            const spacing = 55;
            
            for (let i = 0; i < achievements.length; i++) {
                const y = startY + (i * spacing);
                const achievement = achievements[i];
                
                // Save achievement status to player stats
                if (achievement.requirement && (!playerStats.achievements || !playerStats.achievements[achievement.id])) {
                    if (!playerStats.achievements) playerStats.achievements = {};
                    playerStats.achievements[achievement.id] = true;
                    saveGame();
                }
                
                // Achievement background
                const bgColor = achievement.requirement ? 0x4a9e4a : 0x9e4a4a;
                const bg = this.add.rectangle(400, y, 600, 45, bgColor, 0.7).setOrigin(0.5);
                
                // Achievement text
                this.add.text(150, y, achievement.name, {
                    fontSize: '22px',
                    fill: '#ffffff',
                    fontStyle: 'bold'
                }).setOrigin(0, 0.5);
                
                this.add.text(320, y, achievement.description, {
                    fontSize: '18px',
                    fill: '#ffffff'
                }).setOrigin(0, 0.5);
                
                // Achievement status
                const statusText = achievement.requirement ? 'COMPLETED' : 'LOCKED';
                this.add.text(650, y, statusText, {
                    fontSize: '18px',
                    fill: achievement.requirement ? '#ffff00' : '#ff9999',
                    fontStyle: 'bold'
                }).setOrigin(0.5);
                
                // Add star icon for completed achievements
                if (achievement.requirement) {
                    const star = this.add.image(700, y, 'star').setScale(0.4);
                    
                    // Add star animation
                    this.tweens.add({
                        targets: star,
                        angle: 360,
                        duration: 6000,
                        repeat: -1
                    });
                }
            }
            
            // Back button
            const backBtn = this.add.image(100, 50, 'button').setScale(0.7);
            backBtn.setInteractive({ useHandCursor: true });
            
            this.add.text(100, 50, 'Back', {
                fontSize: '18px',
                fill: '#000'
            }).setOrigin(0.5);
            
            backBtn.on('pointerdown', () => {
                this.sound.play('click');
                this.scene.start('MenuScene');
            });
            
            // Stats display
            const statsText = [
                `Total Coins Collected: ${playerStats.itemsCollected}`,
                `Enemies Defeated: ${playerStats.enemiesDefeated}`,
                `Areas Unlocked: ${playerStats.unlockedAreas}`,
                `Highest Combo: ${playerStats.highestCombo}x`,
                `Daily Login Streak: ${playerStats.dailyStreak}`
            ];
            
            for (let i = 0; i < statsText.length; i++) {
                this.add.text(400, 520 + (i * 25), statsText[i], {
                    fontSize: '16px',
                    fill: '#ffffff'
                }).setOrigin(0.5);
            }
        };
        
        // Daily Bonus Scene
        function DailyBonusScene() {
            Phaser.Scene.call(this, { key: 'DailyBonusScene' });
        }
        
        DailyBonusScene.prototype = Object.create(Phaser.Scene.prototype);
        DailyBonusScene.prototype.constructor = DailyBonusScene;
        
        DailyBonusScene.prototype.create = function() {
            // Background
            this.add.image(400, 300, 'mountains');
            
            // Title
            this.add.text(400, 50, 'Daily Rewards', {
                fontSize: '40px',
                fill: '#ffffff',
                stroke: '#000000',
                strokeThickness: 5
            }).setOrigin(0.5);
            
            // Login streak text
            this.add.text(400, 110, `Current Login Streak: Day ${playerStats.dailyStreak}`, {
                fontSize: '24px',
                fill: '#ffffff',
                stroke: '#000000',
                strokeThickness: 3
            }).setOrigin(0.5);
            
            // Daily rewards grid
            const rewardsPerRow = 7;
            const startX = 170;
            const startY = 200;
            const spacing = 90;
            
            for (let i = 0; i < 7; i++) {
                const x = startX + (i * spacing);
                
                // Day box
                const dayBox = this.add.rectangle(x, startY, 80, 80, 0x000000, 0.7);
                
                // Day number
                this.add.text(x, startY - 25, `Day ${i + 1}`, {
                    fontSize: '18px',
                    fill: '#ffffff'
                }).setOrigin(0.5);
                
                // Reward image and amount
                let rewardImg, rewardAmount;
                
                if ((i + 1) % 7 === 0) {
                    // Every 7th day gets gems
                    rewardImg = this.add.image(x, startY, 'gem').setScale(0.7);
                    rewardAmount = 5;
                } else {
                    // Other days get coins
                    rewardImg = this.add.image(x, startY, 'coin').setScale(0.7);
                    rewardAmount = 50 * (i + 1);
                }
                
                // Reward amount text
                this.add.text(x, startY + 25, `${rewardAmount}`, {
                    fontSize: '16px',
                    fill: '#ffff00'
                }).setOrigin(0.5);
                
                // Show if day is claimed or active
                if (i + 1 < playerStats.dailyStreak) {
                    // Past days (already claimed)
                    this.add.text(x, startY, 'CLAIMED', {
                        fontSize: '14px',
                        fill: '#55ff55'
                    }).setOrigin(0.5);
                } else if (i + 1 === playerStats.dailyStreak) {
                    // Current day - add highlight
                    const highlight = this.add.rectangle(x, startY, 86, 86, 0x55ff55, 0);
                    dayBox.setStrokeStyle(3, 0x55ff55);
                    
                    // Pulse animation for current day
                    this.tweens.add({
                        targets: highlight,
                        alpha: 0.5,
                        duration: 1000,
                        yoyo: true,
                        repeat: -1
                    });
                    
                    // Only show claim button if not claimed today
                    if (!playerStats.claimedToday) {
                        const claimBtn = this.add.image(x, startY + 70, 'button').setScale(0.7, 0.5);
                        claimBtn.setInteractive({ useHandCursor: true });
                        
                        this.add.text(x, startY + 70, 'Claim', {
                            fontSize: '14px',
                            fill: '#000'
                        }).setOrigin(0.5);
                        
                        claimBtn.on('pointerdown', () => {
                            this.sound.play('reward');
                            
                            // Determine and give reward
                            if (playerStats.dailyStreak % 7 === 0) {
                                playerStats.gems += 5;
                                showRewardPopup(this, 'Daily Reward: 5 Gems!');
                            } else {
                                const coinsAmount = 50 * playerStats.dailyStreak;
                                playerStats.coins += coinsAmount;
                                showRewardPopup(this, `Daily Reward: ${coinsAmount} Coins!`);
                            }
                            
                            // Mark as claimed and save
                            playerStats.claimedToday = true;
                            saveGame();
                            
                            // Refresh scene
                            this.scene.restart();
                        });
                    } else {
                        this.add.text(x, startY, 'CLAIMED', {
                            fontSize: '14px',
                            fill: '#55ff55'
                        }).setOrigin(0.5);
                    }
                }
            }
            
            // Daily challenge status
            this.add.text(400, 350, 'Daily Challenge:', {
                fontSize: '26px',
                fill: '#ffffff',
                stroke: '#000000',
                strokeThickness: 3
            }).setOrigin(0.5, 0);
            
            // Get current challenge
            const dailyChallenge = JSON.parse(localStorage.getItem('fairy_kingdom_daily_challenge')) || { text: "No active challenge", completed: false };
            
            this.add.text(400, 390, dailyChallenge.text, {
                fontSize: '22px',
                fill: dailyChallenge.completed ? '#55ff55' : '#ffffff'
            }).setOrigin(0.5, 0);
            
            // Challenge status
            const statusText = dailyChallenge.completed ? 'COMPLETED! (Reward Claimed)' : 'In Progress...';
            const statusColor = dailyChallenge.completed ? '#55ff55' : '#ffff55';
            
            this.add.text(400, 425, statusText, {
                fontSize: '20px',
                fill: statusColor,
                fontStyle: 'bold'
            }).setOrigin(0.5, 0);
            
            // Back button
            const backBtn = this.add.image(100, 50, 'button').setScale(0.7);
            backBtn.setInteractive({ useHandCursor: true });
            
            this.add.text(100, 50, 'Back', {
                fontSize: '18px',
                fill: '#000'
            }).setOrigin(0.5);
            
            backBtn.on('pointerdown', () => {
                this.sound.play('click');
                this.scene.start('MenuScene');
            });
            
            // Add sparkles effect
            const particles = this.add.particles('star');
            
            particles.createEmitter({
                x: 400,
                y: 200,
                speed: { min: 30, max: 70 },
                angle: { min: 0, max: 360 },
                scale: { start: 0.2, end: 0 },
                blendMode: 'ADD',
                lifespan: 2000,
                frequency: 200
            });
        };
        
        // Main Game Scene
        function GameScene() {
            Phaser.Scene.call(this, { key: 'GameScene' });
        }
        
        GameScene.prototype = Object.create(Phaser.Scene.prototype);
        GameScene.prototype.constructor = GameScene;
        
        GameScene.prototype.init = function(data) {
            this.levelNumber = data.level || 1;
            this.collectedItems = 0;
            this.defeatedEnemies = 0;
            this.fireballs = 0;
            this.jumps = 0;
            this.startTime = Date.now();
            this.levelCompleted = false;
            this.gameOver = false;
            
            // Reset combo system
            comboSystem.reset();
        };
        
        GameScene.prototype.create = function() {
            // Create UI scene as overlay
            this.scene.launch('UIScene');
            
            // Background layers (parallax)
            this.skyBg = this.add.tileSprite(400, 300, 800, 600, 'sky');
            this.mountainsBg = this.add.tileSprite(400, 300, 800, 600, 'mountains');
            this.forestBg = this.add.tileSprite(400, 200, 800, 400, 'forest');
            
            // Clouds
            for (let i = 0; i < 5; i++) {
                const cloud = this.add.image(
                    Phaser.Math.Between(0, 800),
                    Phaser.Math.Between(50, 150),
                    'cloud'
                ).setAlpha(0.7).setScale(Phaser.Math.FloatBetween(0.5, 1));
                
                // Random cloud movement
                this.tweens.add({
                    targets: cloud,
                    x: cloud.x + Phaser.Math.Between(100, 200),
                    duration: Phaser.Math.Between(15000, 30000),
                    ease: 'Linear',
                    yoyo: true,
                    repeat: -1
                });
            }
            
            // Platform group
            this.platforms = this.physics.add.staticGroup();
            
            // Create game level based on level number
            this.createLevel(this.levelNumber);
            
            // Player (fairy) setup
            this.player = this.physics.add.sprite(100, 450, 'fairy');
            this.player.setBounce(0.2);
            this.player.setCollideWorldBounds(true);
            this.player.body.setGravityY(300);
            
            // Apply fairy wings powerup if active
            if (playerStats.hasWings) {
                this.player.body.setGravityY(150);
            }
            
            // Player animations
            this.anims.create({
                key: 'left',
                frames: this.anims.generateFrameNumbers('fairy', { start: 0, end: 3 }),
                frameRate: 10,
                repeat: -1
            });
            
            this.anims.create({
                key: 'turn',
                frames: [ { key: 'fairy', frame: 4 } ],
                frameRate: 20
            });
            
            this.anims.create({
                key: 'right',
                frames: this.anims.generateFrameNumbers('fairy', { start: 5, end: 8 }),
                frameRate: 10,
                repeat: -1
            });
            
            // Player sparkle trail
            this.playerTrail = this.add.particles('sparkle');
            this.playerTrailEmitter = this.playerTrail.createEmitter({
                follow: this.player,
                scale: { start: 0.2, end: 0 },
                speed: 20,
                lifespan: 600,
                frequency: 100,
                blendMode: 'ADD'
            });
            
            // Explosion animation
            this.anims.create({
                key: 'explode',
                frames: this.anims.generateFrameNumbers('explosion', { start: 0, end: 23 }),
                frameRate: 30,
                repeat: 0,
                hideOnComplete: true
            });
            
            // Input setup
            this.cursors = this.input.keyboard.createCursorKeys();
            this.fireKey = this.input.keyboard.addKey('F');
            this.shopKey = this.input.keyboard.addKey('E');
            this.musicToggleKey = this.input.keyboard.addKey('M');
            
            // Fireball group
            this.fireballs = this.physics.add.group();
            
            // Items group
            this.coins = this.physics.add.group();
            this.gems = this.physics.add.group();
            this.rings = this.physics.add.group();
            this.powerups = this.physics.add.group();
            
            // Enemy group
            this.enemies = this.physics.add.group({
                allowGravity: false
            });
            
            // Finish flag
            this.finish = this.physics.add.staticGroup();
            
            // Colliders
            this.physics.add.collider(this.player, this.platforms);
            this.physics.add.collider(this.fireballs, this.platforms, this.hitPlatform, null, this);
            this.physics.add.collider(this.coins, this.platforms);
            this.physics.add.collider(this.gems, this.platforms);
            this.physics.add.collider(this.rings, this.platforms);
            this.physics.add.collider(this.powerups, this.platforms);
            
            // Overlap handlers
            this.physics.add.overlap(this.player, this.coins, this.collectCoin, null, this);
            this.physics.add.overlap(this.player, this.gems, this.collectGem, null, this);
            this.physics.add.overlap(this.player, this.rings, this.collectRing, null, this);
            this.physics.add.overlap(this.player, this.powerups, this.collectPowerup, null, this);
            this.physics.add.overlap(this.player, this.enemies, this.hitEnemy, null, this);
            this.physics.add.overlap(this.fireballs, this.enemies, this.hitEnemyWithFireball, null, this);
            this.physics.add.overlap(this.player, this.finish, this.reachFinish, null, this);
            
            // Camera follow player
            this.cameras.main.setBounds(0, 0, this.levelWidth, 600);
            this.cameras.main.startFollow(this.player, true, 0.05, 0.05);
            
            // Lives display
            this.lives = playerStats.lives;
            this.updateLivesDisplay();
            
            // Level timer
            this.timeText = this.add.text(16, 16, 'Time: 0', {
                fontSize: '18px',
                fill: '#ffffff',
                stroke: '#000000',
                strokeThickness: 3
            }).setScrollFactor(0);
            
            this.levelTimer = this.time.addEvent({
                delay: 1000,
                callback: this.updateTimer,
                callbackScope: this,
                loop: true
            });
            
            // Fireball cooldown timer
            this.fireballCooldown = false;
            this.lastFireballTime = 0;
            
            // Show level text
            const levelText = this.add.text(400, 100, `Level ${this.levelNumber}`, {
                fontSize: '48px',
                fill: '#ffffff',
                fontStyle: 'bold',
                stroke: '#000000',
                strokeThickness: 6
            }).setOrigin(0.5).setScrollFactor(0);
            
            // Level text animation
            this.tweens.add({
                targets: levelText,
                y: 50,
                alpha: 0,
                duration: 2000,
                ease: 'Power2',
                delay: 1000
            });
            
            // Level objectives
            this.updateDailyChallengeUI();
            
            // Background music
            if (!this.sound.get('music')) {
                this.sound.play('music', { loop: true, volume: 0.5 });
            }
            
            // Music toggle
            this.musicToggleKey.on('down', function() {
                if (this.sound.get('music').isPlaying) {
                    this.sound.get('music').pause();
                } else {
                    this.sound.get('music').resume();
                }
            }, this);
            
            // Shop toggle handler
            this.shopKey.on('down', function() {
                const shopUI = document.getElementById('ui-overlay');
                if (shopUI.style.display === 'block') {
                    shopUI.style.display = 'none';
                    this.scene.resume();
                } else {
                    shopUI.style.display = 'block';
                    document.getElementById('coins-display').textContent = `Fairy Coins: ${playerStats.coins}`;
                    document.getElementById('gems-display').textContent = `Magic Gems: ${playerStats.gems}`;
                    this.scene.pause();
                }
            }, this);
            
            // Shop close button handler
            document.getElementById('close-shop').addEventListener('click', () => {
                document.getElementById('ui-overlay').style.display = 'none';
                this.scene.resume();
            });
            
            // Update shop UI
            updateShopUI();
        };
        
        GameScene.prototype.update = function() {
            if (this.gameOver || this.levelCompleted) {
                // Don't process updates if game over or level completed
                return;
            }
            
            // Player horizontal movement
            if (this.cursors.left.isDown) {
                this.player.setVelocityX(-playerStats.speed);
                this.player.anims.play('left', true);
                this.playerTrailEmitter.setPosition(this.player.x + 10, this.player.y);
            } else if (this.cursors.right.isDown) {
                this.player.setVelocityX(playerStats.speed);
                this.player.anims.play('right', true);
                this.playerTrailEmitter.setPosition(this.player.x - 10, this.player.y);
            } else {
                this.player.setVelocityX(0);
                this.player.anims.play('turn');
            }
            
            // Player jump
            if (this.cursors.up.isDown && this.player.body.touching.down) {
                this.sound.play('jump');
                this.player.setVelocityY(-playerStats.jumpPower);
                this.jumps++;
                
                // Add jump effect
                const jumpParticles = this
